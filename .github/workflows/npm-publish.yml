# This workflow runs comprehensive tests and publishes the package to npm when a GitHub release is created
# For more information see: https://docs.github.com/en/actions/publishing-packages/publishing-nodejs-packages

name: TurboDocx NPM Release - Node.js Package

on:
  release:
    types: [created]  # Trigger when a new release is published on GitHub

jobs:
  # Run all test suites to validate the release before publishing
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      # Install dependencies with clean install (respects package-lock.json exactly)
      - run: npm ci

      # Run all test suites: unit tests, integration tests, heading styles examples, and TypeScript tests
      - run: npm run test:all

  # Publish the package to npm registry (only runs if build job passes)
  publish-npm:
    needs: build  # Wait for tests to pass before publishing
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          registry-url: https://registry.npmjs.org/  # Configure npm registry for publishing

      # Install dependencies
      - run: npm ci

      # Build the production bundle (bundles modules, minifies code with terser)
      - run: npm run build:prod

      # Publish to npm with public access (scoped packages are private by default)
      - run: npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{secrets.npm_token}}  # Use npm token from GitHub secrets
