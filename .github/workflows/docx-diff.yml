# This workflow compares DOCX output between base branch and PR branch
# Ensures no unexpected regressions in document generation

name: DOCX Output Diff

on:
  pull_request:
    branches:
      - main
      - develop

jobs:
  docx-diff:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write  # Needed to post PR comments
      contents: read

    steps:
      - name: Get PR details
        id: pr
        run: |
          echo "base_ref=${{ github.event.pull_request.base.ref }}" >> $GITHUB_OUTPUT
          echo "head_ref=${{ github.event.pull_request.head.ref }}" >> $GITHUB_OUTPUT

      - name: Checkout base branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.base.sha }}
          path: baseline

      - name: Setup Node.js for baseline
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'npm'
          cache-dependency-path: baseline/package-lock.json

      - name: Install dependencies (baseline)
        working-directory: baseline
        run: npm ci

      - name: Generate baseline DOCX
        working-directory: baseline
        run: |
          npm run build
          node example/example-deterministic.js
          mv example-node.docx ../baseline.docx

      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          path: current

      - name: Setup Node.js for current
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'npm'
          cache-dependency-path: current/package-lock.json

      - name: Install dependencies (current)
        working-directory: current
        run: npm ci

      - name: Generate current DOCX
        working-directory: current
        run: |
          npm run build
          node example/example-deterministic.js
          mv example-node.docx ../current.docx

      - name: Run DOCX diff
        id: diff
        working-directory: current
        run: |
          node scripts/diff-docx.js ../baseline.docx ../current.docx --output ../diff-report.md || echo "diff_failed=true" >> $GITHUB_OUTPUT

      - name: Read diff report
        id: report
        run: |
          if [ -f diff-report.md ]; then
            {
              echo 'report<<EOF'
              cat diff-report.md
              echo EOF
            } >> $GITHUB_OUTPUT
          fi

      - name: Post diff report as comment
        if: steps.report.outputs.report != ''
        uses: actions/github-script@v7
        with:
          script: |
            const report = `${{ steps.report.outputs.report }}`;

            // Find existing comment
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.data.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('DOCX Diff Report')
            );

            const commentBody = `${report}\n\n---\n*This comment was automatically generated by the DOCX diff workflow*`;

            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: commentBody
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: commentBody
              });
            }

      - name: Upload diff report as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: docx-diff-report
          path: |
            baseline.docx
            current.docx
            diff-report.md
          retention-days: 30

      - name: Check diff status
        if: steps.diff.outputs.diff_failed == 'true'
        run: |
          echo "::error::DOCX diff detected unexpected changes. Please review the diff report."
          exit 1
